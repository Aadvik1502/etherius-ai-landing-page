<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Etherius AI Analytics Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #0F172A;
            color: #fff;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
        }

        .header h1 {
            color: #CEFC55;
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }

        .stat-card {
            background: #1E293B;
            padding: 20px;
            border-radius: 10px;
            border: 1px solid #334155;
            text-align: center;
        }

        .stat-card h3 {
            color: #CEFC55;
            font-size: 1.2rem;
            margin-bottom: 10px;
        }

        .stat-card .number {
            font-size: 2rem;
            font-weight: bold;
            color: #fff;
        }

        .charts-section {
            margin-top: 40px;
        }

        .chart-card {
            background: #1E293B;
            padding: 30px;
            border-radius: 10px;
            border: 1px solid #334155;
            margin-bottom: 30px;
        }

        .chart-card h3 {
            color: #CEFC55;
            margin-bottom: 20px;
        }

        .leads-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .leads-table th,
        .leads-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #334155;
        }

        .leads-table th {
            background: #0F172A;
            color: #CEFC55;
        }

        .error {
            background: #ef4444;
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #64748B;
        }

        .refresh-btn {
            background: #CEFC55;
            color: #0F172A;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            margin-bottom: 20px;
        }

        .refresh-btn:hover {
            background: #a3d145;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìä Etherius AI Analytics Dashboard</h1>
            <p>Real-time website performance and lead tracking</p>
            <button class="refresh-btn" onclick="loadAnalytics()">üîÑ Refresh Data</button>
        </div>

        <div id="loading" class="loading">
            <h3>Loading analytics data...</h3>
        </div>

        <div id="error" class="error" style="display: none;">
            <h3>‚ùå Error loading data</h3>
            <p id="error-message"></p>
        </div>

        <div id="dashboard" style="display: none;">
            <!-- Key Metrics -->
            <div class="stats-grid">
                <div class="stat-card">
                    <h3>Total Visitors</h3>
                    <div class="number" id="total-visitors">-</div>
                </div>
                <div class="stat-card">
                    <h3>Leads Generated</h3>
                    <div class="number" id="total-leads">-</div>
                </div>
                <div class="stat-card">
                    <h3>Conversion Rate</h3>
                    <div class="number" id="conversion-rate">-</div>
                </div>
                <div class="stat-card">
                    <h3>Avg. Time on Page</h3>
                    <div class="number" id="avg-time">-</div>
                </div>
            </div>

            <!-- Recent Analytics Events -->
            <div class="chart-card">
                <h3>üìà Recent Website Activity</h3>
                <table class="leads-table">
                    <thead>
                        <tr>
                            <th>Event Type</th>
                            <th>Session</th>
                            <th>Page URL</th>
                            <th>Timestamp</th>
                        </tr>
                    </thead>
                    <tbody id="recent-events">
                    </tbody>
                </table>
            </div>

            <!-- Recent Leads -->
            <div class="chart-card">
                <h3>üéØ Recent Leads</h3>
                <table class="leads-table">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Company</th>
                            <th>Industry</th>
                            <th>Investment Range</th>
                            <th>Status</th>
                            <th>Date</th>
                        </tr>
                    </thead>
                    <tbody id="recent-leads">
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = 'https://etherius-ai-backend.onrender.com/api';

        async function loadAnalytics() {
            try {
                document.getElementById('loading').style.display = 'block';
                document.getElementById('error').style.display = 'none';
                document.getElementById('dashboard').style.display = 'none';

                // Load analytics data
                const analyticsResponse = await fetch(`${API_BASE}/admin/analytics`);
                const leadsResponse = await fetch(`${API_BASE}/admin/leads`);

                if (!analyticsResponse.ok || !leadsResponse.ok) {
                    throw new Error('Failed to fetch data from server');
                }

                const analytics = await analyticsResponse.json();
                const leads = await leadsResponse.json();

                // Calculate metrics
                const pageViews = analytics.filter(event => event.event_type === 'page_view').length;
                const totalLeads = leads.length;
                const conversionRate = pageViews > 0 ? ((totalLeads / pageViews) * 100).toFixed(2) : '0';

                const timeEvents = analytics.filter(event => event.event_type === 'time_on_page');
                const avgTime = timeEvents.length > 0
                    ? Math.round(timeEvents.reduce((sum, event) => {
                        const data = JSON.parse(event.event_data || '{}');
                        return sum + (data.timeInSeconds || 0);
                    }, 0) / timeEvents.length)
                    : 0;

                // Update dashboard
                document.getElementById('total-visitors').textContent = pageViews;
                document.getElementById('total-leads').textContent = totalLeads;
                document.getElementById('conversion-rate').textContent = conversionRate + '%';
                document.getElementById('avg-time').textContent = avgTime + 's';

                // Recent events
                const recentEvents = analytics.slice(-10).reverse();
                const eventsHTML = recentEvents.map(event => {
                    const date = new Date(event.created_at).toLocaleString();
                    const sessionShort = event.session_id ? event.session_id.slice(-8) : 'N/A';
                    return `
                        <tr>
                            <td>${event.event_type}</td>
                            <td>${sessionShort}</td>
                            <td>${event.page_url || 'N/A'}</td>
                            <td>${date}</td>
                        </tr>
                    `;
                }).join('');
                document.getElementById('recent-events').innerHTML = eventsHTML;

                // Recent leads
                const recentLeads = leads.slice(-10).reverse();
                const leadsHTML = recentLeads.map(lead => {
                    const date = new Date(lead.created_at).toLocaleDateString();
                    return `
                        <tr>
                            <td>${lead.full_name}</td>
                            <td>${lead.company_name}</td>
                            <td>${lead.industry}</td>
                            <td>${lead.investment_range}</td>
                            <td>${lead.status}</td>
                            <td>${date}</td>
                        </tr>
                    `;
                }).join('');
                document.getElementById('recent-leads').innerHTML = leadsHTML;

                document.getElementById('loading').style.display = 'none';
                document.getElementById('dashboard').style.display = 'block';

            } catch (error) {
                console.error('Error loading analytics:', error);
                document.getElementById('loading').style.display = 'none';
                document.getElementById('error').style.display = 'block';
                document.getElementById('error-message').textContent = error.message;
            }
        }

        // Load data when page loads
        loadAnalytics();

        // Auto-refresh every 5 minutes
        setInterval(loadAnalytics, 5 * 60 * 1000);
    </script>
</body>
</html>